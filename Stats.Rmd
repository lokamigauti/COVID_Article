---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

# Important Topics

* Get more than 1 case in the same city to refine the error bar

  * Boston is a good study case

* We will adjust the model in 1 city and validate it with others


```{r, warning=FALSE}
library(readr)
library(tidyverse)
library(ggisoband)
library(corrplot)
library(stats)
library(lubridate)
library(modelr)
library(mgcv)
library(pracma)
library(RColorBrewer)
library(magrittr)
ccf2 <- function(df){
  x <- df[,1] %>% as.vector()
  y <- df[,2] %>% as.vector()
  return(ccf(x = x, y = y, type = "correlation", plot = TRUE, lag.max = 50))
}
cor2 <- function(df){
  x <- df[,1] %>% as.vector()
  y <- df[,2] %>% as.vector()
  return(cor(x = x, y = y, method = "spearman"))
}
cor2test <- function(df){
  x <- df[,1] %>% as.vector()
  y <- df[,2] %>% as.vector()
  test <- cor.test(x = x, y = y)
  return(test$p.value)
}
shaptest <- function(df){
  x <- df[,1] %>% as.vector()
  y <- df[,2] %>% as.vector()
  return(shapiro.test(x = x, y = y))
}
lm_eqn <- function(df){
  colnames(df) <- c("x", "y")
  m <- lm(y ~ x, df);
  eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
       list(a = format(unname(coef(m)[1]), digits = 2),
            b = format(unname(coef(m)[2]), digits = 2),
           r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));
}
N_casos <- function(x){
  y <- c()
  y[1] <- x[1]
  for(i in 2:length(x)){
    y[i] <- ifelse((x[i] - x[i-1]) < 0, 0, (x[i] - x[i-1]))
  }
  return(y)
}
```

```{r}
ds <- read_csv("meteorological_variables_daily_mean.csv", 
    col_types = cols(time = col_datetime(format = "%Y-%m-%d")))
ds$covid_cases[is.na(ds$covid_cases)] <- 0
ds$uvb[is.na(ds$uvb)] <- 0 #remover com atualização do ERA5
ds$fdir[is.na(ds$fdir)] <- 0 #remover com atualização do ERA5
ds$t2m[is.na(ds$t2m)] <- 0 #remover com atualização do ERA5
```

```{r}
lags = 0:20
mavgs = 2:8
i = 1
correlations <- data.frame(mavgs = NA, lags = NA, corr = NA, city = NA)
rowtoappend <- data.frame(mavgs = NA, lags = NA, corr = NA, city = NA)

cities <- ds %>%
  group_by(location_name) %>%
  summarize(case = max(covid_cases)) %>%
  mutate(location_name = ifelse(case < 300, NA, location_name)) %>%
  na.omit() %>%
  pull(location_name) %>%
  as.vector()

for(city in cities){
  for(nlag in lags){
      correlations[i,"lags"] <- nlag
      correlations[i,"mavgs"] <- 1
      a <- ds %>%
        filter(location_name == city) %>%
        select(median_pm25, covid_cases_first_derivative, time, covid_cases, is_quarentined) %>%
        mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
        #filter(time > as.Date("2020-03-20")) %>%
        filter(covid_cases > 5) %>%
        filter(is_quarentined == 1) %>%
        select(median_pm25, covid_cases_first_derivative) %>%
        na.omit()
      correlations[i,"corr"] <- a %>%
        cor2 %>%
        as.numeric()
      a <- tryCatch(cor.test(a$median_pm25, a$covid_cases_first_derivative, method = "spearman", exact = FALSE), error = function(e) NA)
      correlations[i,"corr_p"] <- tryCatch(a$p.value, error = function(e) NA)
      correlations[i,"city"] <- city %>% as.character()
      i <- i + 1
  }
}

for(city in cities){
  for(nlag in lags){
    for(nmavg in mavgs){
      rowtoappend[i,"lags"] <- nlag
      rowtoappend[i,"mavgs"] <- nmavg
      a <- ds %>%
        filter(location_name == city) %>%
        select(median_pm25, covid_cases_first_derivative, time, covid_cases, is_quarentined) %>%
        mutate(median_pm25 = lag(movavg(median_pm25, n = nmavg, type = "s"), n = nlag)) %>%
        #filter(time > as.Date("2020-03-20")) %>% 
        filter(covid_cases > 5) %>%
        filter(is_quarentined == 1) %>%
        select(median_pm25, covid_cases_first_derivative) %>%
        na.omit()
      rowtoappend[i,"corr"] <- a %>%
        cor2 %>%
        as.numeric()
      a <- tryCatch(cor.test(a$median_pm25, a$covid_cases_first_derivative, method = "spearman", exact = FALSE), error = function(e) NA)
      rowtoappend[i,"corr_p"] <- tryCatch(a$p.value, error = function(e) NA)
      rowtoappend[i,"city"] <- city %>% as.character()
      i <- i + 1 
    }
  }
}

correlations <- bind_rows(correlations, rowtoappend)

the_corr_plot <- correlations %>%
  na.omit %>%
  transform(lags = as.factor(lags)) %>%
  transform(mavgs = as.factor(mavgs)) %>%
  group_by(mavgs, lags) %>%
  summarise(sdcorr = as.numeric(sd(corr, na.rm = TRUE)), meancorr = mean(corr), mediancorr = median(corr))

write.csv(the_corr_plot, file = "corr_df.csv")

write.csv(correlations, file = "corr_by_county.csv")

library(ggalt)

plot <- correlations %>%
  filter(corr_p < 0.05) %>%
  na.omit %>%
  transform(lags = as.factor(lags)) %>%
  transform(mavgs = as.factor(mavgs)) %>%
  transform(city = as.factor(city)) %>%
  group_by(mavgs, lags) %>%
  summarise(sdcorr = as.numeric(sd(corr, na.rm = TRUE)), corr = mean(corr), n = n()) %>%
  filter(corr > 0)

plot %>%
  ggplot(aes(x = lags, y = mavgs, z = corr))+
  geom_raster(aes(fill = corr))+
  geom_text(aes(label = n))+
  geom_tile(alpha = 0, colour = "black")+
  #geom_tile(aes(colour = as.factor(sdcorrfactor)),alpha = 0)+
  #geom_encircle(data = subsetplot, s_shape = 1)+
  scale_fill_distiller(palette = "RdBu")+
  theme_light()+
  theme(panel.grid.major = element_blank())
```


```{r}
nlag = 12
ds %>%
  mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
  mutate(uvb = lag(uvb, n = nlag)) %>%
  mutate(t2m = lag(t2m, n = nlag)) %>%
  mutate(fdir = lag(fdir, n = nlag)) %>%
  filter(is_quarentined == FALSE) %>%
  filter(covid_cases > 5) %>% # 5 BECAUSE NUMERIC SHINENIGANS
  na.omit() %>%
  select(uvb, t2m, fdir, median_pm25, covid_cases, covid_cases_first_derivative) %>%
  cor(method = "spearman") %>%
  corrplot(method = "color", type = "upper", title = "Sem Quarentena")
ds %>%
  mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
  mutate(uvb = lag(uvb, n = nlag)) %>%
  mutate(t2m = lag(t2m, n = nlag)) %>%
  mutate(fdir = lag(fdir, n = nlag)) %>%
  filter(is_quarentined == TRUE) %>%
  filter(covid_cases > 5) %>%
  na.omit() %>%
  select(uvb, t2m, fdir, median_pm25, covid_cases, covid_cases_first_derivative) %>%
  cor(method = "spearman") %>%
  corrplot(method = "color", type = "lower", title = "Quarentena")
ds %>%
  mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
  mutate(uvb = lag(uvb, n = nlag)) %>%
  mutate(t2m = lag(t2m, n = nlag)) %>%
  mutate(fdir = lag(fdir, n = nlag)) %>%
  #filter(is_quarentined == FALSE) %>%
  filter(covid_cases > 5) %>%
  na.omit() %>%
  select(uvb, t2m, fdir, median_pm25, covid_cases, covid_cases_first_derivative) %>%
  cor(method = "spearman") %>%
  corrplot(method = "color", type = "lower", title = "Total")


M <- ds %>%
  mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
  mutate(uvb = lag(uvb, n = nlag)) %>%
  mutate(t2m = lag(t2m, n = nlag)) %>%
  mutate(fdir = lag(fdir, n = nlag)) %>%
  filter(is_quarentined == TRUE) %>%
  filter(covid_cases > 5) %>%
  na.omit() %>%
  select(uvb, t2m, fdir, median_pm25, covid_cases, covid_cases_first_derivative) %>%
  cor(method = "spearman")
  
M %>% 
  as.data.frame() %>%
  rownames_to_column("var") %>%
  select(var, covid_cases_first_derivative) %>%
  filter(var %in% c("uvb", "t2m", "median_pm25")) %>%
  transform(var = as.factor(var)) %>%
  ggplot(aes(x = var, y = covid_cases_first_derivative))+
  geom_col()

ds %>%
  mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
  mutate(uvb = lag(uvb, n = nlag)) %>%
  mutate(t2m = lag(t2m, n = nlag)) %>%
  mutate(fdir = lag(fdir, n = nlag)) %>%
  filter(is_quarentined == TRUE) %>%
  filter(covid_cases > 5) %>%
  na.omit() %>%
  select(uvb, t2m, fdir, median_pm25, covid_cases, covid_cases_first_derivative, covid_cases_second_derivative) %>%
  cor(method = "spearman") %>%
  corrplot(method = "color", type = "lower", title = "Quarentena")
```

```{r}
i = 1
models <- data.frame(city = NA, k = NA, k_sd = NA, k_t = NA, k_p = NA, v = NA, v_sd = NA, v_t = NA, v_p = NA)

for(city in cities){
  
  models[i, "city"] <- city
  
  data_training <- ds %>%
    select(covid_cases, population, location_name) %>%
    filter(location_name == city) %>%
    filter(covid_cases > 5) %>%
    na.omit() %>%
    select(covid_cases, population) %>%
    mutate(day = 1:nrow(.))
  
  tryCatch(currentmodel <- nls(covid_cases ~ (population*k/(1+exp(5 + v*day))), data = data_training, start = list(k = 0.01, v = -1), control = list(maxiter = 1000)) %>% summary(), error = function(e) NA)
  
  if(is.na(currentmodel) == TRUE) {
    models[i,"k"] <- NA
    models[i,"k_sd"] <- NA
    models[i,"k_t"] <- NA
    models[i,"k_p"] <- NA
    models[i,"v"] <- NA
    models[i,"v_sd"] <- NA
    models[i,"v_t"] <- NA
    models[i,"v_p"] <- NA
  }
  else{
    models[i,"k"] <- currentmodel$coefficients[1,1]
    models[i,"k_sd"] <- currentmodel$coefficients[1,2]
    models[i,"k_t"] <- currentmodel$coefficients[1,3]
    models[i,"k_p"] <- currentmodel$coefficients[1,4]
    models[i,"v"] <- currentmodel$coefficients[2,1]
    models[i,"v_sd"] <- currentmodel$coefficients[2,2]
    models[i,"v_t"] <- currentmodel$coefficients[2,3]
    models[i,"v_p"] <- currentmodel$coefficients[2,4]
    m <- nls(covid_cases ~ (population*k/(1+exp(5 + v*day))), data = data_training, start = list(k = 0.01, v = -1), control = list(maxiter = 1000))
    plot(data_training$day, data_training$covid_cases, xlim = c(0, 30), main = city)
    lines(data_training$day, predict(m, newdata = data_training))
  }
  
  i <- i + 1
}

models_rsqr <- data.frame(city = NA, k = NA, k_sd = NA, k_t = NA, k_p = NA, v = NA, v_sd = NA, v_t = NA, v_p = NA, pm_25 = NA, pm_10 = NA, uv = NA, t = NA, density = NA, population = NA, lag = NA, mvavg = NA)
lags = 0:20
mavgs = 2:8
i = 1
j = 1
for(city in cities){
  for(nlag in lags){
    data_training <- ds %>%
      filter(location_name == city) %>%
      mutate(median_pm25 = lag(median_pm25, n = nlag)) %>%
      mutate(median_pm10 = lag(median_pm10, n = nlag)) %>%
      mutate(uvb = lag(uvb, n = nlag)) %>%
      mutate(t2m = lag(t2m, n = nlag)) %>%
      filter(covid_cases > 5) %>%
      select(uvb, t2m, median_pm25, median_pm10, population, density) %>%
      summarise(uvb_sd = sd(uvb, na.rm = TRUE),
                t2m_sd = sd(t2m, na.rm = TRUE), 
                median_pm25_sd = sd(median_pm25, na.rm = TRUE), 
                median_pm10_sd = sd(median_pm10, na.rm = TRUE),
                uvb = mean(uvb, na.rm = TRUE), 
                t2m = mean(t2m, na.rm = TRUE), 
                median_pm25 = mean(median_pm25, na.rm = TRUE), 
                median_pm10 = mean(median_pm10, na.rm = TRUE), 
                population = mean(population, na.rm = TRUE), 
                density = mean(density, na.rm = TRUE))
    
    models_rsqr[j, "k"] <- models[i, "k"]
    models_rsqr[j, "k_sd"] <- models[i, "k_sd"]
    models_rsqr[j, "k_t"] <- models[i, "k_t"]
    models_rsqr[j, "k_p"] <- models[i, "k_p"]
    models_rsqr[j, "v"] <- models[i, "v"] * -1
    models_rsqr[j, "v_sd"] <- models[i, "v_sd"]
    models_rsqr[j, "v_t"] <- models[i, "v_t"]
    models_rsqr[j, "v_p"] <- models[i, "v_p"]
    
    models_rsqr[j, "pm_25"] <- data_training["median_pm25"]
    models_rsqr[j, "pm_10"] <- data_training["median_pm10"]
    models_rsqr[j, "uv"] <- data_training["uvb"]
    models_rsqr[j, "t"] <- data_training["t2m"]
    models_rsqr[j, "density"] <- data_training["density"]
    models_rsqr[j, "population"] <- data_training["population"]
    
    models_rsqr[j, "pm_25_sd"] <- data_training["median_pm25_sd"]
    models_rsqr[j, "pm_10_sd"] <- data_training["median_pm10_sd"]
    models_rsqr[j, "uv_sd"] <- data_training["uvb_sd"]
    models_rsqr[j, "t_sd"] <- data_training["t2m_sd"]
    
    models_rsqr[j, "lag"] <- nlag
    models_rsqr[j, "mvavg"] <- 1
    models_rsqr[j, "city"] <- city
    
    j <- j + 1
  }
  i <- i + 1
}
i = 1
for(city in cities){
  for(nlag in lags){
    for(nmavg in mavgs){
      data_training <- ds %>%
        filter(location_name == city) %>%
        mutate(median_pm25 = lag(movavg(median_pm25, n = nmavg, type = "s"), n = nlag)) %>%
        mutate(median_pm10 = lag(movavg(median_pm10, n = nmavg, type = "s"), n = nlag)) %>%
        mutate(uvb = lag(movavg(uvb, n = nmavg, type = "s"), n = nlag)) %>%
        mutate(t2m = lag(movavg(t2m, n = nmavg, type = "s"), n = nlag)) %>%
        filter(covid_cases > 5) %>%
        select(uvb, t2m, median_pm25, median_pm10, population, density) %>%
        summarise(uvb_sd = sd(uvb, na.rm = TRUE),
                  t2m_sd = sd(t2m, na.rm = TRUE), 
                  median_pm25_sd = sd(median_pm25, na.rm = TRUE), 
                  median_pm10_sd = sd(median_pm10, na.rm = TRUE),
                  uvb = mean(uvb, na.rm = TRUE), 
                  t2m = mean(t2m, na.rm = TRUE), 
                  median_pm25 = mean(median_pm25, na.rm = TRUE), 
                  median_pm10 = mean(median_pm10, na.rm = TRUE), 
                  population = mean(population, na.rm = TRUE), 
                  density = mean(density, na.rm = TRUE))
      
      models_rsqr[j, "k"] <- models[i, "k"]
      models_rsqr[j, "k_sd"] <- models[i, "k_sd"]
      models_rsqr[j, "k_t"] <- models[i, "k_t"]
      models_rsqr[j, "k_p"] <- models[i, "k_p"]
      models_rsqr[j, "v"] <- models[i, "v"] * -1
      models_rsqr[j, "v_sd"] <- models[i, "v_sd"]
      models_rsqr[j, "v_t"] <- models[i, "v_t"]
      models_rsqr[j, "v_p"] <- models[i, "v_p"]
      
      models_rsqr[j, "pm_25"] <- data_training["median_pm25"]
      models_rsqr[j, "pm_10"] <- data_training["median_pm10"]
      models_rsqr[j, "uv"] <- data_training["uvb"]
      models_rsqr[j, "t"] <- data_training["t2m"]
      models_rsqr[j, "density"] <- data_training["density"]
      models_rsqr[j, "population"] <- data_training["population"]
      
      models_rsqr[j, "pm_25_sd"] <- data_training["median_pm25_sd"]
      models_rsqr[j, "pm_10_sd"] <- data_training["median_pm10_sd"]
      models_rsqr[j, "uv_sd"] <- data_training["uvb_sd"]
      models_rsqr[j, "t_sd"] <- data_training["t2m_sd"]
      
      models_rsqr[j, "lag"] <- nlag
      models_rsqr[j, "mvavg"] <- nmavg
      models_rsqr[j, "city"] <- city
      
      j <- j + 1
    }
  }
  i <- i + 1
}

not_fitted <- c("Columbus", "Little Rock", "Memphis", "Salem")
bad_fitted <- c("Charlotte", "Jackson", "Madison", "Oklahoma City", "Phoenix", "Portland", "Salt Lake City", "Tucson", "Honolulu")
notwell_fitted <- c("Austin", "Boise", "Boston", "Columbia", "Chicago", "Fresno", "Houston", "Los Angeles", "Milwaukee", "Nashville", "Providence")
not_perfect <- c("Dallas", "Denver", "Indianapolis", "Manhattan")

hard <- c("Austin", "Boise", "Boston", "Charlotte", "Chicago", "Columbia", "Columbus", "Fresno", "Honolulu", "Houston", "Indianapolis", "Jackson", "Las Vegas", "Little Rock", "Los Angeles", "Madison", "Manhattan", "Memphis", "Milwaukee", "Nashville", "Oklahoma City", "Phoenix", "Portland", "Salem", "Salt Lake City", "San Francisco", "Tucson")

models_rsqr1 <- models_rsqr %>%
   filter(!city %in% not_fitted)
models_rsqr2 <- models_rsqr1 %>% 
   filter(!city %in% bad_fitted)
models_rsqr3 <- models_rsqr2 %>% 
   filter(!city %in% notwell_fitted)
models_rsqr4 <- models_rsqr3 %>% 
   filter(!city %in% not_perfect)

models_rsqr0 <- models_rsqr %>% 
   filter(!city %in% hard)

r2_df <- models_rsqr0 %>%
  group_by(lag, mvavg) %>%
  do(r2 = summary(lm(t ~ v, data =.data))$r.squared) %>%
  mutate(r2 = extract2(r2, 1))

r2_df %>%
  ggplot(aes(x = lag, y = mvavg))+
    geom_raster(aes(fill = r2))+
    geom_tile(alpha = 0, colour = "black")+
    scale_fill_distiller(palette = "RdBu")+
    theme_light()+
    theme(panel.grid.major = element_blank())

p <- models_rsqr0 %>%
  filter(lag == 12, mvavg == 1) %>%
  select(pm_10, v)

models_rsqr0 %>%
  filter(lag == 12, mvavg == 1) %>%
  ggplot(aes(y = v, x = pm_10, label = city))+
  geom_point()+
  geom_errorbar(aes(ymin = v - v_sd, ymax = v + v_sd))+
  geom_errorbarh(aes(xmin = pm_10 - pm_10_sd, xmax = pm_10 + pm_10_sd))+
  geom_smooth(method = "lm", se = FALSE)+
  geom_text(y = 0.225, x = 20, label = lm_eqn(p), parse = TRUE)+
  xlab("Average Daily Particulate Matter") + ylab("COVID 19 Cases' Growth Rate")+
  geom_text(aes(label=city),hjust=-0.06, vjust=-0.5)
  

```